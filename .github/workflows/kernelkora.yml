name: GKI | Build BBRv3 + Cubic Modules

on:
  workflow_dispatch:

jobs:
  build-bbrv3:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git ccache flex bison make libssl-dev libelf-dev bc wget curl dwarves

      - name: Clone GKI Kernel Source
        run: |
          mkdir android-kernel && cd android-kernel
          git clone --depth=1 -b Rebase https://github.com/dopaemon/android_kernel_xiaomi_common.git common
          cd common
          echo "KERNEL_PATH=$(pwd)" >> $GITHUB_ENV

      - name: Download Google Clang r416183b
        run: |
          mkdir -p $GITHUB_WORKSPACE/clang
          cd $GITHUB_WORKSPACE/clang

          curl -L -o clang.tar.gz \
            https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/06a71ddac05c22edb2d10b590e1769b3f8619bef/clang-r416183b.tar.gz

          tar -xf clang.tar.gz
          echo "CLANG_PATH=$GITHUB_WORKSPACE/clang/bin" >> $GITHUB_ENV
          ./bin/clang --version

      - name: Patch kernel for Clang r416183b compatibility
        run: |
          cd $KERNEL_PATH

          # 1. eliminar flag regalloc-enable-advisor
          sed -i 's/-regalloc-enable-advisor=[a-zA-Z0-9_-]*//g' Makefile

          # 2. eliminar flags exclusivos de LLVM 14+
          sed -i 's/-mlsl//g' Makefile
          sed -i 's/-moutline-atomics//g' Makefile
          sed -i 's/-fno-stack-protector-guard//g' Makefile
          sed -i 's/-mbranch-protection=pac-ret//g' Makefile

          # 3. algunos kernels lo incluyen en scripts/*
          find . -type f -name "Makefile*" -exec sed -i 's/-regalloc-enable-advisor=[^ ]*//g' {} \;
          find . -type f -name "Makefile*" -exec sed -i 's/-moutline-atomics//g' {} \;

          echo "ðŸ”¥ Kernel patched for Clang r416183b"
          
      - name: Enable BBRv3 and CUBIC as modules
        run: |
          cd $KERNEL_PATH

          sed -i '/drivers\/kernelsu\/kernel\/Kconfig/d' drivers/Kconfig || true

          echo "CONFIG_TCP_CONG_BBR=m" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_TCP_CONG_CUBIC=m" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_DEFAULT_CUBIC=n" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_DEFAULT_BBR=n" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_TCP_CONG_BBR3=n" >> arch/arm64/configs/gki_defconfig

          sed -Ei 's/(\.name[[:space:]]*=[[:space:]]*")bbr(")/\1bbrv3\2/' net/ipv4/tcp_bbr.c

      - name: Build tcp_bbrv3.ko and tcp_cubic.ko
        run: |
          cd $KERNEL_PATH
          export PATH="$CLANG_PATH:$PATH"
          export ARCH=arm64
          export CC=clang
          export LLVM=1
          export LLVM_IAS=1
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CROSS_COMPILE_COMPAT=arm-linux-gnueabi-

          make ARCH=arm64 gki_defconfig
          make ARCH=arm64 CC=clang CROSS_COMPILE=aarch64-linux-gnu- modules_prepare

          make ARCH=arm64 CC=clang CROSS_COMPILE=aarch64-linux-gnu- M=net/ipv4 modules

          find . -name "tcp_bbr.ko" -exec cp {} $GITHUB_WORKSPACE/tcp_bbrv3.ko \;
          find . -name "tcp_cubic.ko" -exec cp {} $GITHUB_WORKSPACE/tcp_cubic.ko \;

      - name: Upload tcp_bbrv3.ko
        uses: actions/upload-artifact@v4
        with:
          name: tcp_bbrv3-module
          path: tcp_bbrv3.ko

      - name: Upload tcp_cubic.ko
        uses: actions/upload-artifact@v4
        with:
          name: tcp_cubic-module
          path: tcp_cubic.ko
